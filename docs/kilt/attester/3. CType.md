# CType ğŸ¯

`CTYPE`, yani Claim Type, KILT protokolÃ¼ iÃ§in Ã¶zel bir terimdir. AslÄ±nda, bu oldukÃ§a basit bir konsept: `CTYPE` bir `claim` ya da TÃ¼rkÃ§e'de `iddia`nÄ±n veri modelidir. ğŸ“Š

:::info ğŸŒŸ CTYPE'a BakÄ±ÅŸ ğŸŒŸ

- KILT, iÅŸletmeler ve tÃ¼keticiler iÃ§in Ã¶z-yÃ¶netimli, doÄŸrulanabilir kimlik bilgileri ve DID'ler saÄŸlar. ğŸ›¡ï¸ Ama hangi tÃ¼r kimlik bilgilerinden bahsediyoruz? ğŸ¤”ğŸ”

- Kimlik bilgilerimizi nasÄ±l saklayabiliriz? ğŸ—‚ï¸ DoldurmamÄ±z gereken belirli bir form var mÄ±? ğŸ“ TÃ¼m bu sorularÄ± yanÄ±tlayacaÄŸÄ±z! ğŸ˜ğŸ‘

- Diyelim ki bazÄ± verileri onaylatmak istiyorsunuz. ğŸ“‹ Bu verilerin iÃ§inde adÄ±nÄ±z, konumunuz gibi daha kÃ¼Ã§Ã¼k parÃ§alar var. Peki, bu verileri bir onaylayÄ±cÄ±ya nasÄ±l sunacaksÄ±nÄ±z? ğŸ¤·â€â™‚ï¸ Hangi ÅŸablonda? ğŸ“‘

- CTypes'Ä± tanÄ±yalÄ±m! ğŸ‰ CTypes, kimlik bilgilerinin ÅŸemalarÄ±dÄ±r. ğŸ“‹ Ä°htiyacÄ±nÄ±z olan "form oluÅŸturma araÃ§larÄ±" olarak hizmet edebilirler. ğŸ› ï¸

- CTypes, bir iddianÄ±n yapÄ±sÄ±nÄ±, veri modeli dahil, tanÄ±mlayan KILT'a Ã¶zgÃ¼ veri tipleridir. ğŸ“Šâœ… JSON ÅemasÄ±'na dayanmaktadÄ±rlar, bu da JSON belgelerini aÃ§Ä±klamak ve doÄŸrulamak iÃ§in kullanÄ±lan bir standarttÄ±r. ğŸ“œ

- Kendi CTypes'Ä±nÄ±zÄ± oluÅŸturabilir ğŸ› ï¸ ve bunlarÄ± zincirde saklayabilir veya ihtiyacÄ±nÄ±zÄ± karÅŸÄ±lamak iÃ§in zincirde zaten var olan CTypes'Ä± kullanabilirsiniz. ğŸ’¡ğŸ”—
:::

Attesterlar, bir `attest` yani `onay` iÅŸlemi yapmadan Ã¶nce, hangi `Ctype` formatÄ±nÄ± destekleyeceklerini belirlemelidir. ğŸ¯ Ã–rneÄŸin, sÃ¼rÃ¼cÃ¼ kurslarÄ± sadece ehliyetle alakalÄ± onaylama yapabilirler, evin mesken alanÄ± ile alakalÄ± bir onaylama yapamazlar. ğŸš—ğŸ 

:::tip ğŸŒ 
CTYPE'lar standartlaÅŸmasÄ± hedeflenen Ã¶ÄŸelerdir. ğŸ¯ Yeni bir Ctype oluÅŸturmadan Ã¶nce olanlarÄ± kullanmak bÃ¼yÃ¼k Ã¶lÃ§Ã¼de Ã¶nerilir. ğŸ‘
:::

Workshop'ta sÃ¼reci Ã¶ÄŸrenmek iÃ§in kendi CTYPE'Ä±mÄ±zÄ± yaratacaÄŸÄ±z! ğŸ› ï¸ğŸ‰

:::note ğŸ“
CType, bir `credential`'Ä±n iÃ§erisinde gerekli tÃ¼m bilgilerin var olmasÄ±nÄ± teyit eder. ğŸ›¡ï¸ Ã–rneÄŸin, bir ehliyette doÄŸum tarihi, isim ve hangi tÃ¼r aracÄ±n kullanÄ±lma izninin olduÄŸu yer alÄ±r. ğŸš—ğŸ“… Bu bilgiler, ehliyetimizi kontrol eden polis memurunun bizi onaylamasÄ± iÃ§in gerekli olan bilgilerdir. ğŸš“ğŸ‘®â€â™‚ï¸
:::

CType oluÅŸturmak iÃ§in zincir Ã¼zerinde bir `full DID` gereklidir. ğŸ†” AyrÄ±ca, bu hesabÄ±n iÃ§erisinde `PILT` coinlerinin olduÄŸundan emin olmalÄ±yÄ±z, Ã§Ã¼nkÃ¼ CType oluÅŸturma iÅŸlemi bizden bir miktar Ã¶deme alacak. ğŸ’°

## Ã–rnek bir CTYPE'a bakalÄ±m

Hadi kafamÄ±zda tam oturmasÄ± iÃ§in Ã¶rnek bir CType incelelim, bu iÅŸlem iÃ§in de yine ehliyeti Ã¶rnek gÃ¶sterebiliriz:

```json
{
  "$id": "kilt:ctype:0x4f1d68ac46daf4613181b33b16faaf10cf94879dc2246d7485dc2ccbb843641d",
  "$schema": "ipfs://bafybeiah66wbkhqbqn7idkostj2iqyan2tstc4tpqt65udlhimd7hcxjyq/",
  "additionalProperties": false,
  "properties": {
    "age": {
      "type": "integer"
    },
    "id": {
      "type": "string"
    },
    "name": {
      "type": "string"
    }
  },
  "title": "Drivers License by did:kilt:4t9FPVbcN42UMxt3Z2Y4Wx38qPL8bLduAB11gLZSwn5hVEfH",
  "type": "object"
}
```

:::tip
YukarÄ±daki kod yapÄ±sÄ±nÄ± inceleyecek olursak ilk olarak bu yapÄ±nÄ±n `JSON` formatÄ±na benzediÄŸini gÃ¶rebiliriz ki bu durumda haklÄ± oluruz. CType'lar temellerinde JavaScript Objeleri olarak tasarlanmÄ±ÅŸtÄ±r.
:::

SatÄ±r satÄ±r bu niteliklere bakacak olursak:

| Anahtar                | DeÄŸer                                                                                                                                                               |
| ---------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `$id`                  | Bu CType'Ä±n KILT kimliÄŸi. CType'Ä±n **dijital izi**'ni temsil ettiÄŸi iÃ§in en Ã¶nemli Ã¶zelliÄŸidir.                                                                      |
| `$schema`              | Bir CType'Ä±n nasÄ±l gÃ¶rÃ¼nebileceÄŸini tanÄ±mlayan meta-ÅŸemaya bir referans. Ä°ki versiyonu vardÄ±r.                                                                       |
| `title`                | CType'Ä±n baÅŸlÄ±ÄŸÄ±.                                                                                                                                                   |
| `properties`           | Bu CType'a uygun bir iddianÄ±n sahip olabileceÄŸi Ã¶zellikler.                                                                                                         |
| `type`                 | TÃ¼m CType'lar iÃ§in `type` bir nesnedir.                                                                                                                             |
| `additionalProperties` | VarsayÄ±lan olarak false olarak ayarlanmÄ±ÅŸtÄ±r. Bu, bir iddiada istenmeyen Ã¶zelliklerin sÄ±nÄ±rlanmasÄ±nÄ± saÄŸlar.                                                         |

Ctypelar KILT Blokzinciri Ã¼zerinde depolanmaktadÄ±r. 

GerÃ§ek hayatta CType'larÄ± var olan bir depodan veya zincirden Ã§ekmemiz gerekmektedir.

Bu workshop iÃ§erisinde `Attester` bireyimiz kendi bir CType oluÅŸturup test zincirine yÃ¼kleyecektir.

## CType OluÅŸturma

Ctype oluÅŸturmak iÃ§in alt kÄ±sÄ±mdaki gibi bir yapÄ± oluÅŸturabiliriz:

```typescript title="ctypeSchema"
import * as Kilt from '@kiltprotocol/sdk-js'

// Return CType with the properties matching a given schema.
export function getCtypeSchema(): Kilt.ICType {
  return Kilt.CType.fromProperties('Drivers License', {
    name: {
      type: 'string'
    },
    age: {
      type: 'integer'
    }
  })
}
```

Bu kodun nasÄ±l Ã§alÄ±ÅŸtÄ±ÄŸÄ±na satÄ±r satÄ±r bakacak olursak:

- Ä°lk olarak KILT-SDK'yi kodumuzun iÃ§erisine eklemekle baÅŸlayabiliriz.
- SonrasÄ±nda `getCtypeSchema` adÄ±n da bir fonksiyon tanÄ±mlanÄ±rÄ±z. 
- Son olarak gerekli bilgileri alarak `CType.fromProperties` fonksiyonu ile Ctype'a Ã§evirmeye hazÄ±r hale getiririz.


## CType'Ä± Elde Etme

Åimdi CTYPE'larÄ±n olup olmadÄ±ÄŸÄ±nÄ± kontrol ederek olmamasÄ± durumunda oluÅŸturacak kodumuzu yazabiliriz.

### KÃ¼tÃ¼phane Ekleme

```typescript title="generateCtype"
import { config as envConfig } from 'dotenv'
import * as Kilt from '@kiltprotocol/sdk-js'
import { generateAccount } from './generateAccount'
import { generateKeypairs } from './generateKeypairs'
import { getCtypeSchema } from './ctypeSchema'
```

Bu kÄ±sÄ±mda eklediÄŸimiz paketleri incelediÄŸimizde daha Ã¶nceden de eklediÄŸimiz paketlerin yer aldÄ±ÄŸÄ±nÄ± gÃ¶rÃ¼ntÃ¼leyebiliriz. Bu paketlerden daha Ã¶nce kullanmadÄ±ÄŸÄ±mÄ±z `getCtypeSchema` gÃ¶zÃ¼mÃ¼ze Ã§arpabilir. Bu paket daha Ã¶ncesinde yazdÄ±ÄŸÄ±mÄ±z `ctypeSchema.ts` dosyasÄ±ndan  `getCtypeSchema` methoduna eriÅŸmektedir. 

### `ensureStoredCtype` Fonksiyonu

```typescript title="generateCtype"
export async function ensureStoredCtype(
  attesterAccount: Kilt.KiltKeyringPair,
  attesterDid: Kilt.DidUri,
  signCallback: Kilt.SignExtrinsicCallback
): Promise<Kilt.ICType> {
  // ...
}
```

Tabii, `ensureStoredCtype` fonksiyonu Ã¼Ã§ parametre alÄ±yor ve bir `Promise` dÃ¶ndÃ¼rÃ¼yor. Fonksiyonun amacÄ±, bir CType'Ä±n (Claim Type) zaten KILT blockchain'de kayÄ±tlÄ± olup olmadÄ±ÄŸÄ±nÄ± kontrol etmek ve eÄŸer deÄŸilse, onu oluÅŸturmaktÄ±r. Bu parametrelere bakacak olursak:

1. **`attesterAccount: Kilt.KiltKeyringPair`**: Bu, iÅŸlemleri imzalamak iÃ§in kullanÄ±lacak olan KILT hesabÄ±nÄ±n anahtar Ã§iftini temsil eder.
2. **`attesterDid: Kilt.DidUri`**: Bu, iÅŸlemleri yetkilendirmek iÃ§in kullanÄ±lacak olan Decentralized Identifier (DID) URI'yi temsil eder.
3. **`signCallback: Kilt.SignExtrinsicCallback`**: Bu, iÅŸlemi imzalamak iÃ§in kullanÄ±lacak olan callback fonksiyonudur.

:::note
`Promise<Kilt.ICType>`: Fonksiyon, oluÅŸturulan veya zaten var olan CType'Ä± dÃ¶ndÃ¼ren bir `Promise` dÃ¶ndÃ¼rÃ¼r.
:::

#### KILT API'sini Almak
```typescript title="generateCtype"
const api = Kilt.ConfigService.get('api');
```
KILT API'sini alÄ±r, bu API Ã¼zerinden blockchain ile etkileÅŸime geÃ§ilecektir.

#### CType ÅemasÄ±nÄ± Almak
```typescript title="generateCtype"
const ctype = getCtypeSchema();
```
Ã–nceden tanÄ±mlanmÄ±ÅŸ bir CType ÅŸemasÄ±nÄ± alÄ±r. Bu ÅŸemayÄ± daha Ã¶nce yazdÄ±ÄŸÄ±mÄ±z `ctypeSchema.ts` dosyasÄ±ndan elde etmektedir. Bu dosya iÃ§erisinden CType'Ä± alarak projemiz iÃ§erisine ekler.

### CType'Ä±n Olup OlmadÄ±ÄŸÄ±nÄ± Kontrol Etmek

```typescript title="generateCtype"
try {
  await Kilt.CType.verifyStored(ctype)
  console.log('Ctype already stored. Skipping creation')
  return ctype
} catch {
  // ...
}
```

OluÅŸturacaÄŸÄ±mÄ±z CType'lar zincirde aynÄ± ÅŸekilde var olabilir. Bu durumlarda yeniden bir CType'Ä± zincire eklemek bizlere gereksiz bir Ã¼crete malolacaktÄ±r. Bu durumu Ã¶nlemek iÃ§in `try` yapÄ±sÄ± iÃ§erisinde `CType.verifyStored()` methodu ile ÅŸemamÄ±zÄ±n var olup olmadÄ±ÄŸÄ±nÄ± kontrol edebiliriz. EÄŸer hali hazÄ±rda depolanmÄ±ÅŸ ise bu durum kullanÄ±cÄ±ya sÃ¶ylenir ve `ctype`'Ä± dÃ¶ndÃ¼rerek devam eder.

:::caution EÄŸer KayÄ±tlÄ± DeÄŸilse?
Ctype'Ä±n kayÄ±tlÄ± olmamasÄ± durumunda `catch` yapÄ±sÄ± Ã§alÄ±ÅŸacaktÄ±r.
:::

#### CType OluÅŸturmak ve Kaydetmek

Zincirde CType'Ä±n bulunmadÄ±ÄŸÄ±na emin olduÄŸumuzda zincire oluÅŸturduÄŸumuz CType'Ä± ekleyebiliriz.

```typescript title="generateCtype"
console.log('Ctype not present. Creating it now...');
const encodedCtype = Kilt.CType.toChain(ctype);
const tx = api.tx.ctype.add(encodedCtype);

const extrinsic = await Kilt.Did.authorizeTx(
  attesterDid,
  tx,
  signCallback,
  attesterAccount.address
);
await Kilt.Blockchain.signAndSubmitTx(extrinsic, attesterAccount);
return ctype;
```

Ãœst KÄ±sÄ±mda CType'Ä± oluÅŸturup zincire eklememiz iÃ§in gerekli kod ifade edilmiÅŸtir. Bu kodu sÄ±rasÄ±yla inceleyecek olursak:

- `encodedCtype`: Ctype'Ä± ÅŸema olarak oluÅŸturduk ancak zincirin iÃ§erisine ekleyebileceÄŸimiz ÅŸekilde ÅŸifrelememiz gerekmektedir. Bu iÅŸlemi `CType.toChain()` ile gerÃ§ekleÅŸtirebiliriz. 
- `tx`: CType'Ä± zincire eklememiz iÃ§in bu CType'Ä±n transferini gerÃ§ekleÅŸtirmemiz gerekmektedir. Bu transfer iÃ§in de Ctype'Ä± `tx.ctype.add` fonksiyonu ile hazÄ±rlayabiliriz.
- `extrinsic`: Zincire ekleyeceÄŸimiz transferi uygun formata getirmek iÃ§in kullanÄ±rÄ±z. Bu transfer sayesinde zincir ile etkileÅŸime geÃ§eceÄŸimiz iÃ§in `attesterDid` deÄŸerini kullanmamÄ±z gerekmektedir.
- `signAndSubmitTx`: Son olarak iÅŸlemi zincire imzalayarak gÃ¶ndereririz.


### Ana Kod BloÄŸu

Bu kÄ±sÄ±m yine diÄŸer kodlarda olduÄŸu gibi `generateCtype.ts` dosyasÄ± direkt olarak Ã§aÄŸÄ±rÄ±lÄ±rsa nasÄ±l Ã§alÄ±ÅŸacaÄŸÄ±nÄ± ifade etmektedir. 

```typescript title="generateCtype"
if (require.main === module) {
  ;(async () => {
    // ...
  })()
}
```

Kodun direkt olarak Ã§alÄ±ÅŸtÄ±rÄ±lÄ±p Ã§alÄ±ÅŸtÄ±rÄ±lmadÄ±ÄŸÄ±na bir `if` yapÄ±sÄ± ile bakarÄ±z. EÄŸer direkt olarak Ã§alÄ±ÅŸtÄ±rÄ±lÄ±yorsa altÄ±nda bulunan kodlar Ã§alÄ±ÅŸÄ±r.

#### Ã‡evre DeÄŸiÅŸkenleri ve BaÄŸlantÄ±

```typescript title="generateCtype"
envConfig()
await Kilt.connect(process.env.WSS_ADDRESS as string)
```
Ã‡evre deÄŸiÅŸkenleri yÃ¼klenir ve KILT blockchain'ine baÄŸlanÄ±lÄ±r.

#### Hesap ve DID OluÅŸturma

```typescript title="generateCtype"
const accountMnemonic = process.env.ATTESTER_ACCOUNT_MNEMONIC as string
const { account } = generateAccount(accountMnemonic)
const didMnemonic = process.env.ATTESTER_DID_MNEMONIC as string
const { authentication, assertionMethod } = generateKeypairs(didMnemonic)
const attesterDidUri = Kilt.Did.getFullDidUriFromKey(authentication)
```
Mnemonic kullanarak bir hesap ve DID (Decentralized Identifier) oluÅŸturulur.

#### `ensureStoredCtype` Fonksiyonunun Ã‡aÄŸrÄ±lmasÄ±

```typescript title="generateCtype"
await ensureStoredCtype(account, attesterDidUri, async ({ data }) => ({
  signature: assertionMethod.sign(data),
  keyType: assertionMethod.type
}))
```
`ensureStoredCtype` fonksiyonu Ã§aÄŸrÄ±lÄ±r ve gerekli iÅŸlemler yapÄ±lÄ±r.



:::info Genel Bir BakÄ±ÅŸ YapalÄ±m
Hadi birlikte yazdÄ±ÄŸÄ±mÄ±z `generateCtype.ts` dosyasÄ±nÄ±n nasÄ±l Ã§alÄ±ÅŸtÄ±ÄŸÄ±na tÃ¼m kodu bir arada gÃ¶rerek bakalÄ±m.

```typescript title="generateCtype"
import { config as envConfig } from 'dotenv'

import * as Kilt from '@kiltprotocol/sdk-js'

import { generateAccount } from './generateAccount'
import { generateKeypairs } from './generateKeypairs'
import { getCtypeSchema } from './ctypeSchema'

export async function ensureStoredCtype(
  attesterAccount: Kilt.KiltKeyringPair,
  attesterDid: Kilt.DidUri,
  signCallback: Kilt.SignExtrinsicCallback
): Promise<Kilt.ICType> {
  const api = Kilt.ConfigService.get('api')

  // Get the CTYPE and see if it's stored, if yes return it.
  const ctype = getCtypeSchema()
  try {
    await Kilt.CType.verifyStored(ctype)
    console.log('Ctype already stored. Skipping creation')
    return ctype
  } catch {
    console.log('Ctype not present. Creating it now...')
    // Authorize the tx.
    const encodedCtype = Kilt.CType.toChain(ctype)
    const tx = api.tx.ctype.add(encodedCtype)
    const extrinsic = await Kilt.Did.authorizeTx(
      attesterDid,
      tx,
      signCallback,
      attesterAccount.address
    )

    // Write to chain then return the CType.
    await Kilt.Blockchain.signAndSubmitTx(extrinsic, attesterAccount)

    return ctype
  }
}

// Don't execute if this is imported by another file.
if (require.main === module) {
  ;(async () => {
    envConfig()

    try {
      await Kilt.connect(process.env.WSS_ADDRESS as string)

      const accountMnemonic = process.env.ATTESTER_ACCOUNT_MNEMONIC as string
      const { account } = generateAccount(accountMnemonic)

      const didMnemonic = process.env.ATTESTER_DID_MNEMONIC as string
      const { authentication, assertionMethod } = generateKeypairs(didMnemonic)
      const attesterDidUri = Kilt.Did.getFullDidUriFromKey(authentication)

      await ensureStoredCtype(account, attesterDidUri, async ({ data }) => ({
        signature: assertionMethod.sign(data),
        keyType: assertionMethod.type
      }))
    } catch (e) {
      console.log('Error while checking on chain ctype')
      throw e
    }
  })()
}
```

SÄ±rasÄ±yla kodu inceleyecek olursak:
- Ä°lk olarak paketleri yÃ¼kleriz.
- `ctypeSchema.ts` dosyasÄ±ndan ÅŸemamÄ±zÄ± Ã§ekerek kodumuzun iÃ§erisine ekleriz.
- Zincir Ã¼zerinde oluÅŸturmak istediÄŸimiz CType'Ä±n olup olmadÄ±ÄŸÄ±nÄ± kontrol ederiz.
- Zincirde yoksa nasÄ±l ekleyebileceÄŸimizin kodunu yazarÄ±z.
- Dosya tek baÅŸÄ±na Ã§alÄ±ÅŸtÄ±rÄ±lacak olursa yapÄ±lacak Ctype iÅŸlemlerini yazarÄ±z.
:::

Bu ÅŸekilde zincirin iÃ§erisinde oluÅŸturacaÄŸÄ±mÄ±z CType'Ä±n olup olmadÄ±ÄŸÄ±nÄ± inceleyen ve yoksa oluÅŸturan bir kod yazdÄ±k.

:::danger unutmayÄ±n
Zincir Ã¼zerine eklemek iÃ§in bir deposito Ã¶dememiz gerekmektedir. Bu nedenle PILT Coinlere ihtiyacÄ±mÄ±z var unutmayalÄ±m.
:::


## Ã‡alÄ±ÅŸtÄ±rma

Kodumuzu Ã§alÄ±ÅŸtÄ±rmak iÃ§in terminalde `kilt-rocks` klasÃ¶rÃ¼nde olduÄŸumuzdan emin olduktan sonra  ÅŸu kodu Ã§alÄ±ÅŸtÄ±rabiliriz:

```terminal
yarn ts-node attester/generateCtype.ts
```

:::caution SÄ±rada Ne Var?
Eveeeet ÅŸimdi, artÄ±k Ctype'Ä± da oluÅŸturduÄŸumuza gÃ¶re bizden bir `attestation` isteyecek `Claimer` bireyine ihtiyacÄ±mÄ±z var.
:::
