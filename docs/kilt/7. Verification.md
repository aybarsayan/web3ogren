# Verification (DoÄŸrulama) ğŸ¯

Bu kÄ±sÄ±mda `Verifier` bireyinin rollerini birlikte gerÃ§ekleÅŸtireceÄŸiz. 

![alternative text](../../static/img/kilt/verify-me.jpg "Welcome")

Bu iÅŸlemler:

- ğŸ“¥ `Claimer` tarafÄ±ndan verilen `Presentation` objesini teslim alacaÄŸÄ±z.
- ğŸ§ Veri iÃ§erisindeki bilgilerin doÄŸruluÄŸunu kontrol edeceÄŸiz.
- ğŸ”— `attestation` iÅŸleminin doÄŸru olup olmadÄ±ÄŸÄ±nÄ± zincirdeki hash deÄŸerini kontrol ederek onaylayacaksÄ±n. Bu attestation `revoke` da edilmiÅŸ olabilir. Bu duruma da bakmak gerekir.
- ğŸ¤” GÃ¶nderilen kimlik belgesinin `Claimer` tarafÄ±ndan gÃ¶nderildiÄŸine emin olacaksÄ±n.

:::tip ğŸ‰ Presentation: Åimdi ben PowerPoint Sunumu mu hazÄ±rlÄ±cam birde yuha!
`Presentation` yani tÃ¼rkÃ§esi ile sunum yaptÄ±ÄŸÄ±mÄ±z belge `credential` kullanÄ±larak Ã¼retilecek belgedir. Bir `presentation` `credential`'in aksine iÃ§erisindeki belgelerin bazÄ±larÄ±nÄ± saklayabilir. Bu bilgiler `verifier`'lar tarafÄ±ndan bilinmesi gerekmeyen bilgilerdir. Bu `presentation` aynÄ± zamanda `credential`'in `Claimer`'a ait olduÄŸunu kanÄ±tlamaktadÄ±r.
:::

:::info ğŸ¤“ Verification Neydi ya hatÄ±rlasak mÄ±?

ğŸ” Bir Claimer, onaylanmÄ±ÅŸ bir Kimlik Bilgisini (Credential) aldÄ±ÄŸÄ±nda, bunu cÃ¼zdanlarÄ±nda saklayabilir. Ancak bu kimlik bilgisinin bir kopyasÄ± yoksa, geÃ§erliliÄŸini nasÄ±l belirleyebiliriz?

ğŸ”’ KILT, bir Claimer tarafÄ±ndan bir kimlik bilgisinde sunulan bilgilerin doÄŸruluÄŸunu ve geÃ§erliliÄŸini bir DoÄŸrulayÄ±cÄ±ya (Verifier) doÄŸrulama olanaÄŸÄ± tanÄ±r. 

ğŸ’¡ DoÄŸrulayÄ±cÄ±, bu Ã¼Ã§Ã¼ncÃ¼ tarafa ya doÄŸrudan kendi itibarlarÄ±na dayanarak ya da OnaylayÄ±cÄ±nÄ±n dahil olduÄŸu bir delegasyon yapÄ±sÄ± aracÄ±lÄ±ÄŸÄ±yla gÃ¼ven duyar.

âœ… DoÄŸrulama sÃ¼reci iÃ§in:

ğŸ”‘ Claimer, kimlik bilgisi ve tanÄ±mlayÄ±cÄ±larÄ±yla iliÅŸkilendirilmiÅŸ Ã¶zel anahtara ihtiyaÃ§ duyar.

ğŸ”’ DoÄŸrulayÄ±cÄ±, gÃ¼vendiÄŸi OnaylayÄ±cÄ±nÄ±n tanÄ±mlayÄ±cÄ±sÄ±na ihtiyaÃ§ duyar.

ğŸ” DoÄŸrulama sÃ¼reci sÄ±rasÄ±nda, Claimer, DoÄŸrulayÄ±cÄ±ya Ã¼Ã§ ÅŸeyi kanÄ±tlamayÄ± amaÃ§lar:

1ï¸âƒ£ Kimlik bilgisi geÃ§erlidir ve OnaylayÄ±cÄ± tarafÄ±ndan iptal edilmemiÅŸtir.
2ï¸âƒ£ Kimlik bilgisinde belirtilen Ã¶zellikler gerÃ§ekten Claimer'a aittir.
3ï¸âƒ£ Kimlik bilgisi, belirli bir kullanÄ±m durumu iÃ§in DoÄŸrulayÄ±cÄ± iÃ§in ilgili bilgileri iÃ§erir.
:::

## ğŸ¨ Presentation OluÅŸturma

Sadece Claimer'Ä± gÃ¶nderip Verifier'Ä±n doÄŸrulmasÄ±nÄ± bekleyemez. AynÄ± zamanda bu `credantial` ile birlikte o `credantial`'in sahibi olduÄŸunu kanÄ±tlamasÄ± gerekmektedir. Bu sahipliÄŸi kanÄ±tlamak iÃ§in bir `presentation` oluÅŸturup imzalamasÄ± gerekmektedir.

### ğŸ“¦ Paketlerin Eklenmesi:

```typescript title="claimer/createPresentation.ts"
import * as Kilt from '@kiltprotocol/sdk-js'
```
Bu satÄ±r, KILT SDK'sÄ±nÄ± projeye dahil eder. Bu SDK, KILT protokolÃ¼ ile etkileÅŸimde bulunmak iÃ§in gerekli fonksiyonlarÄ± ve sÄ±nÄ±flarÄ± saÄŸlar.

### **ğŸ›  `createPresentation` Fonksiyonu**:

```typescript title="claimer/createPresentation.ts"
export async function createPresentation(
  credential: Kilt.ICredential,
  signCallback: Kilt.SignCallback,
  challenge?: string
): Promise<Kilt.ICredentialPresentation> {
```
Bu fonksiyon, bir kimlik bilgisi sunumu oluÅŸturmak iÃ§in asenkron bir fonksiyondur. ÃœÃ§ parametre alÄ±r:

- `credential`: DoÄŸrulayÄ±cÄ±ya sunulacak olan kimlik bilgisi.
- `signCallback`: Kimlik bilgisi sunumunun imzalanmasÄ± iÃ§in kullanÄ±lacak geri Ã§aÄŸÄ±rma fonksiyonu.
- `challenge`: Opsiyonel bir parametre. Bu, doÄŸrulayÄ±cÄ±nÄ±n talep ettiÄŸi rastgele bir dizedir ve kimlik bilgisi sunumunun doÄŸrulayÄ±cÄ± tarafÄ±ndan talep edildiÄŸini doÄŸrulamak iÃ§in kullanÄ±lÄ±r.

Fonksiyon, bir `ICredentialPresentation` nesnesi dÃ¶ndÃ¼rÃ¼r. Bu nesne, kimlik bilgisi sunumunun kendisidir.

### **ğŸ¨ Sunumu OluÅŸturma**:

```typescript title="claimer/createPresentation.ts"
return Kilt.Credential.createPresentation({
    credential,
    signCallback,
    challenge
  })
```
Bu kÄ±sÄ±m, `Kilt.Credential.createPresentation` fonksiyonunu kullanarak bir kimlik bilgisi sunumu oluÅŸturur. Bu fonksiyon, yukarÄ±da belirttiÄŸimiz Ã¼Ã§ parametreyi alÄ±r ve bir kimlik bilgisi sunumu dÃ¶ndÃ¼rÃ¼r.

:::note ğŸŒ GeniÅŸ bir bakÄ±ÅŸ yapalÄ±m
Åimdi kodun tamamÄ±na bakarak iÅŸlevini anlamak istersek:

```typescript title="claimer/createPresentation.ts"
import * as Kilt from '@kiltprotocol/sdk-js'

export async function createPresentation(
  credential: Kilt.ICredential,
  signCallback: Kilt.SignCallback,
  challenge?: string
): Promise<Kilt.ICredentialPresentation> {
  // Create the presentation from credential, DID and challenge.
  return Kilt.Credential.createPresentation({
    credential,
    signCallback,
    challenge
  })
}
```
Ã–zetle, bu kod, bir kimlik bilgisi sunumu oluÅŸturmayÄ± saÄŸlar. Bu sunum, bir doÄŸrulayÄ±cÄ±ya kimlik bilgisi sunarken kullanÄ±lÄ±r. DoÄŸrulayÄ±cÄ±, bu sunumu kullanarak kimlik bilgisinin geÃ§erliliÄŸini ve kimlik bilgisi sahibinin kimliÄŸini doÄŸrulayabilir.
:::

## Verify (Onaylama)

Hadi  `verification` kodumuzu yazalÄ±m. Ä°lk olarak `getChallange` adÄ±nda bir fonksiyon oluÅŸturarak `Claimer`'Ä±n imzalayarak `credantial`'a sahip olduÄŸunu kanÄ±tlayacaÄŸÄ±z. 

SonrasÄ±nda `verifyPresentation` fonksiyonu ile gerÃ§ek doÄŸrulama yani `verification` iÅŸlemini gerÃ§ekleÅŸtireceÄŸiz. Bu iÅŸlemler iÃ§in `verify.ts` dosyasÄ±nÄ± kullanacaÄŸÄ±z.

### **Paket ve ModÃ¼l Ä°Ã§e AktarmalarÄ±**

```typescript title="verify.ts"
import { config as envConfig } from 'dotenv'
import * as Kilt from '@kiltprotocol/sdk-js'
import { createPresentation } from './claimer/createPresentation'
import { generateKeypairs } from './claimer/generateKeypairs'
import { generateLightDid } from './claimer/generateLightDid'
```

Bu bÃ¶lÃ¼mde gerekli modÃ¼ller ve paketler iÃ§e aktarÄ±lÄ±yor. Ã–zellikle `dotenv` kullanÄ±larak ortam deÄŸiÅŸkenleri yÃ¼kleniyor ve KILT SDK'sÄ± ile diÄŸer yardÄ±mcÄ± fonksiyonlar dahil ediliyor. Belirtilen Paketleri daha Ã¶ncesinde sÄ±rasÄ±yla birlikte oluÅŸturmuÅŸtuk.

### **Benzersiz Challenge OluÅŸturma**

```typescript title="verify.ts"
function getChallenge(): string {
  return Kilt.Utils.UUID.generate()
}
```

Bu fonksiyon doÄŸrulama sÃ¼reci iÃ§in benzersiz bir challenge oluÅŸturur.

![alternative text](../../static/img/kilt/chosen.gif "Welcome")

### **Sunumu DoÄŸrulama Fonksiyonu**

```typescript title="verify.ts"
async function verifyPresentation(
  presentation: Kilt.ICredentialPresentation,
  challenge: string,
  trustedAttesterUris: Kilt.DidUri[]
): Promise<boolean> {
```

DoÄŸrulama iÅŸlemi iÃ§in bir fonksiyon oluÅŸturarak iÅŸleme baÅŸlayabiliriz. Bu fonksiyon iÃ§erisine 3 adet parametre alacak olup `True` veya `False` olmak Ã¼zere bir `Promise` dÃ¶ndÃ¼recektir. Bu parametrelere bakÄ±lacak olunursa sÄ±rasÄ±yla:

1. `presentation`: DoÄŸrulanacak kimlik bilgisi sunumu.
2. `challenge`: DoÄŸrulayÄ±cÄ±nÄ±n (Verifier) gÃ¶nderdiÄŸi benzersiz deÄŸer. Bu, kimlik bilgisi sunumunun doÄŸrulayÄ±cÄ± tarafÄ±ndan talep edildiÄŸini doÄŸrulamak iÃ§in kullanÄ±lÄ±r.
3. `trustedAttesterUris`: GÃ¼vendiÄŸimiz onaylayÄ±cÄ±larÄ±n (Attester) DID URI'lerinin listesi.

Bu fonksiyon bir credential presentation'u doÄŸrular. Sunumun geÃ§erli olup olmadÄ±ÄŸÄ±nÄ±, sahipliÄŸini ve attestation'Ä±n doÄŸru olup olmadÄ±ÄŸÄ±nÄ± kontrol eder.
#### KILT API'sine EriÅŸim:

```typescript title="verify.ts"
Kilt.ConfigService.get('api')
```

Bu satÄ±r, KILT API'sine eriÅŸim saÄŸlar.

#### Try Catch YapÄ±sÄ±

```typescript title="verify.ts"
try {
	.
	.
	.
  } catch {
    return false
  }
```

SonrasÄ±nda devamÄ±nda bizi ilk olarak bir `try` `catch` yapÄ±sÄ± karÅŸÄ±lar. Bu yapÄ± `attestationun` doÄŸru olup olmadÄ±ÄŸÄ±nÄ± kontrol etmektedir. EÄŸer doÄŸru deÄŸilse yapÄ± `catch` bloÄŸuna yakalanÄ±r ve `false` deÄŸeri ile `attestation`'un zincirde olmadÄ±ÄŸÄ± anlaÅŸÄ±lÄ±r.

#### Sunumu DoÄŸrulama:

```typescript title="verify.ts"
const { revoked, attester } = await Kilt.Credential.verifyPresentation(
  presentation,
  { challenge }
)
```

Try yapÄ±sÄ±nÄ±n iÃ§erisine girildiÄŸinde asÄ±l doÄŸrulamanÄ±n yapÄ±ldÄ±ÄŸÄ± `Kilt.Credential.verifyPresentation` fonksiyonu bizi karÅŸÄ±lamaktadÄ±r. Bu fonskiyon iÃ§erisine 2 adet deÄŸiÅŸken almaktadÄ±r. Bunlar sunulan `presentation` ve `claimer`'Ä±n doÄŸru birey olduÄŸunu kanÄ±tlamak iÃ§in `challange` deÄŸerleridir. 

Bu fonksiyon Ã§Ä±ktÄ± olarak 2 adet deÄŸer dÃ¶ndÃ¼rÃ¼r. Bu deÄŸerler `attestation`'un `revoke` edilip edilmediÄŸini yani geÃ§erliliÄŸini yitirip yitirmediÄŸini ifade eden deÄŸer olmaktayken diÄŸer deÄŸer ise sunumu onaylayan `attester`'Ä±n kim olduÄŸudur.

```typescript title="verify.ts"
if (revoked) {
  return false
}
```

EÄŸer `revoke` deÄŸeri `true` ise yani `credenatial` geÃ§erliliÄŸini yitirmiÅŸse `verification` deÄŸeri `false` olarak Ã§Ä±ktÄ± verilir.

```typescript title="verify.ts"
return trustedAttesterUris.includes(attester)
```

Bu satÄ±r, sunumu onaylayanÄ±n (`attester`) gÃ¼vendiÄŸimiz onaylayÄ±cÄ± listesinde (`trustedAttesterUris`) olup olmadÄ±ÄŸÄ±nÄ± kontrol eder. EÄŸer onaylayÄ±cÄ± bu listede ise, fonksiyon `true` dÃ¶ndÃ¼rÃ¼r, aksi takdirde `false` dÃ¶ndÃ¼rÃ¼r.

:::danger
Bir Verifier'Ä±n kontrol etmesi gereken en Ã¶nemli niteliklerden biri bir `attester`'a gÃ¼venip gÃ¼venmediÄŸidir. EÄŸer gÃ¼venmiyorsa `attestation` zincirde olsun olmasÄ±n belgeyi kabul etmeyebilir. Bu durum `attesterlar` arasÄ±ndaki gÃ¼ven yarÄ±ÅŸÄ±nÄ± oluÅŸturur.
:::

### **DoÄŸrulama AkÄ±ÅŸÄ±** (Verification Flow)

```typescript title="verify.ts"
export async function verificationFlow(
  credential: Kilt.ICredential,
  signCallback: Kilt.SignCallback,
  trustedAttesterUris: Kilt.DidUri[] = []
) {
```

Bu fonksiyon, doÄŸrulama sÃ¼recini yÃ¶netir. Ã–ncelikle bir challenge oluÅŸturur, ardÄ±ndan bir sunum oluÅŸturur ve son olarak sunumu doÄŸrular. Bu fonksiyonda iÃ§erisine 3 adet parametre almaktadÄ±r. Bu parametrelere teker teker bakÄ±lacak olunursa:

1. `credential: Kilt.ICredential`: DoÄŸrulayÄ±cÄ±ya sunulacak olan kimlik bilgisi.
2. `signCallback: Kilt.SignCallback`: Kimlik bilgisi sunumunun imzalanmasÄ± iÃ§in kullanÄ±lacak geri Ã§aÄŸÄ±rma fonksiyonu.
3. `trustedAttesterUris: Kilt.DidUri[]`: DoÄŸrulayÄ±cÄ±nÄ±n gÃ¼vendiÄŸi OnaylayÄ±cÄ±larÄ±n (Attester) DID URI'lerinin listesi. Opsiyonel bir parametre ve varsayÄ±lan olarak boÅŸ bir liste ile baÅŸlar.


:::caution verificationFlow ve verifyPresentation FarkÄ± Ne?
AslÄ±nda bu fonksiyonu oluÅŸturarak tÃ¼m `verification` iÅŸlemini tek bir yerde yÃ¶netmekteyiz. 

`verificationFlow` fonksiyonu, `verifyPresentation` fonksiyonunu iÃ§eren daha geniÅŸ bir doÄŸrulama sÃ¼recini temsil eder. Tek baÅŸÄ±na `verifyPresentation` fonksiyonu sadece bir kimlik bilgisi sunumunun doÄŸruluÄŸunu kontrol eder. Ancak, gerÃ§ek dÃ¼nyada bir doÄŸrulama sÃ¼reci, sadece sunumun doÄŸruluÄŸunu kontrol etmekten daha fazlasÄ±nÄ± gerektirir. Ä°ÅŸte bu yÃ¼zden `verificationFlow` fonksiyonuna ihtiyaÃ§ duyarÄ±z.

`verificationFlow` fonksiyonunun amacÄ± ÅŸunlardÄ±r:

1. **Benzersiz Bir Challenge OluÅŸturma:** DoÄŸrulayÄ±cÄ±, Claimer'a benzersiz bir challenge gÃ¶nderir. Bu, sunumun gerÃ§ek zamanlÄ± olarak ve belirli bir talep iÃ§in oluÅŸturulduÄŸundan emin olmak iÃ§in kullanÄ±lÄ±r.
   
2. **Sunumu OluÅŸturma:** Claimer, bu challenge'Ä± kullanarak kimlik bilgisi sunumunu oluÅŸturur ve imzalar.

3. **Sunumu DoÄŸrulama:** DoÄŸrulayÄ±cÄ±, Claimer'dan alÄ±nan sunumu `verifyPresentation` fonksiyonu ile doÄŸrular.

4. **SonuÃ§larÄ± Bildirme:** Sunum doÄŸruysa, doÄŸrulayÄ±cÄ± baÅŸarÄ±lÄ± bir doÄŸrulama mesajÄ± yazdÄ±rÄ±r. Aksi takdirde, baÅŸarÄ±sÄ±z bir doÄŸrulama mesajÄ± yazdÄ±rÄ±r.

Bu adÄ±mlarÄ±n her biri, merkezi olmayan bir kimlik doÄŸrulama sÃ¼recinin kritik bileÅŸenleridir. `verifyPresentation` fonksiyonu, bu sÃ¼recin sadece bir parÃ§asÄ±dÄ±r. `verificationFlow` fonksiyonu, bu adÄ±mlarÄ± bir araya getirerek tam bir doÄŸrulama sÃ¼reci saÄŸlar. Bu nedenle, sadece `verifyPresentation` fonksiyonuna deÄŸil, aynÄ± zamanda bu adÄ±mlarÄ± birleÅŸtiren `verificationFlow` fonksiyonuna da ihtiyaÃ§ duyarÄ±z.
:::

#### Benzersiz Challenge OluÅŸturma

```typescript title="verify.ts"
const challenge = getChallenge()
```

Bu satÄ±r, Claimer'a gÃ¶nderilmek Ã¼zere benzersiz bir challenge oluÅŸturur. Bu, sunumun gerÃ§ek zamanlÄ± olarak ve belirli bir talep iÃ§in oluÅŸturulduÄŸundan emin olmak iÃ§in kullanÄ±lÄ±r. Bu fonksiyonu Ã¶nceden oluÅŸturmuÅŸtuk.

#### Kimlik Bilgisi Sunumu OluÅŸturma

```typescript title="verify.ts"
const presentation = await createPresentation(
    credential,
    signCallback,
    challenge
)
```

Bu satÄ±r, verilen kimlik bilgisi, imza geri Ã§aÄŸÄ±rma fonksiyonu ve challenge kullanarak bir kimlik bilgisi sunumu oluÅŸturur. Bu fonksiyonu `claimer` klasÃ¶rÃ¼nde birlikte oluÅŸturmuÅŸtuk.
 
#### Sunumu DoÄŸrulama:

```typescript title="verify.ts"
const isValid = await verifyPresentation(
    presentation,
    challenge,
    trustedAttesterUris
)
```

Bu satÄ±r, oluÅŸturulan kimlik bilgisi sunumunu doÄŸrular. EÄŸer sunum geÃ§erliyse, `isValid` deÄŸeri `true` olacaktÄ±r.

#### SonuÃ§larÄ± Bildirme:

```typescript title="verify.ts"
if (isValid) {
    console.log('Verification successful! You are allowed to enter the club ğŸ‰')
} else {
    console.log('Verification failed! ğŸš«')
}
```

Bu kÄ±sÄ±m, sunumun doÄŸruluÄŸuna gÃ¶re bir mesaj yazdÄ±rÄ±r. EÄŸer sunum doÄŸruysa, baÅŸarÄ±lÄ± bir doÄŸrulama mesajÄ± yazdÄ±rÄ±lÄ±r. Aksi takdirde, baÅŸarÄ±sÄ±z bir doÄŸrulama mesajÄ± yazdÄ±rÄ±lÄ±r.

:::info Fonksiyon Ne yaptÄ±?
`verificationFlow()` fonksiyonunun iÃ§eriÄŸine baktÄ±ÄŸÄ±mÄ±zda aslÄ±nda Ã¶nceden yazdÄ±ÄŸÄ±mÄ±z fonksiyonlarÄ± Ã§alÄ±ÅŸtÄ±rÄ±rÄ±z. SÄ±rasÄ±yla
- Claimer'Ä± onaylamak iÃ§in bir `Challange` oluÅŸtururuz.
- Claimer tarafÄ±ndan bir `presentation` oluÅŸtururuz.
- Sunulan doÄŸrulamayÄ± `Verifier` olarak doÄŸrularÄ±z.
:::

### Ana Fonksiyon

Bu bÃ¶lÃ¼m bu dosyanÄ±n doÄŸrudan Ã§alÄ±ÅŸtÄ±rÄ±lmasÄ± durumunda Ã§alÄ±ÅŸacak olan ana fonksiyonu iÃ§erir. Ortam deÄŸiÅŸkenlerini yÃ¼kler, KILT'a baÄŸlanÄ±r ve doÄŸrulama akÄ±ÅŸÄ±nÄ± baÅŸlatÄ±r.

```typescript title="verify.ts"
if (require.main === module) {
  ;(async () => {
```

If yapÄ±sÄ± ile modÃ¼lÃ¼n direkt olarak Ã§alÄ±ÅŸtÄ±rÄ±lÄ±p Ã§alÄ±ÅŸtÄ±rÄ±lmadÄ±ÄŸÄ±nÄ± kontrol ederiz.


#### Ortam DeÄŸiÅŸkenlerinin YÃ¼klenmesi:

```typescript title="verify.ts"
envConfig()
```

Bu satÄ±r, `.env` dosyasÄ±ndaki ortam deÄŸiÅŸkenlerini yÃ¼kler. Bu, projede kullanÄ±lan Ã§eÅŸitli yapÄ±landÄ±rma deÄŸerlerini saklamak iÃ§in kullanÄ±lÄ±r.

#### KILT'a BaÄŸlanma:

```typescript title="verify.ts"
await Kilt.connect(process.env.WSS_ADDRESS as string)
```

Bu satÄ±r, KILT aÄŸÄ±na baÄŸlanÄ±r. BaÄŸlantÄ± adresi `.env` dosyasÄ±ndan alÄ±nÄ±r.

#### Claimer'Ä±n DID Bilgilerini OluÅŸturma:

```typescript title="verify.ts"
const claimerDidMnemonic = process.env.CLAIMER_DID_MNEMONIC as string
const { authentication } = generateKeypairs(claimerDidMnemonic)
const claimerDid = generateLightDid(claimerDidMnemonic)
```

Bu adÄ±mlar, Claimer'Ä±n DID (Decentralized Identifier) bilgilerini oluÅŸturmak iÃ§in kullanÄ±lÄ±r. Bu, kimlik bilgisi sunumunu imzalamak iÃ§in gereklidir.

:::caution
Fark etmiÅŸ olabileceÄŸiniz gibi Claimer'Ä±n DID'sini sorgularken yeni bir `Light DID` oluÅŸturma fonksiyonu Ã§alÄ±ÅŸtÄ±rdÄ±k. Bu durumun nedeni zincir Ã¼zerinde depolanmayan `light DID`'lerin her seferinde yeniden oluÅŸuturulmaya aÃ§Ä±k olmasÄ±dÄ±r. 
:::

`verificationFlow()` fonskiyonunun iÃ§erisinde `presantation` oluÅŸturma fonksiyonu da Ã§alÄ±ÅŸmaktadÄ±r. Bu nedenle `Claimer` bireyinin DID'sine ihtiyaÃ§ vardÄ±r.

#### Attester'Ä±n DID Bilgilerini YÃ¼kleme:

```typescript title="verify.ts"
const attesterDid = process.env.ATTESTER_DID_URI as Kilt.DidUri
```

Bu satÄ±r, Attester'Ä±n DID URI'sini `.env` dosyasÄ±ndan alÄ±r.

#### Kimlik Bilgisini YÃ¼kleme:

```typescript title="verify.ts"
const credential = JSON.parse(process.env.CLAIMER_CREDENTIAL as string)
```

Bu satÄ±r daha Ã¶nceden `attestation` bÃ¶lÃ¼mÃ¼nde kodumuzu Ã§alÄ±ÅŸtÄ±rarak elde ettiÄŸimiz ve `.env` dosyasÄ± iÃ§erisine kaydettiÄŸimiz `Credantial`'Ä±n kod iÃ§erisine eklenmesini saÄŸlamaktadÄ±r.

#### DoÄŸrulama AkÄ±ÅŸÄ±nÄ± BaÅŸlatma:

```typescript title="verify.ts"
await verificationFlow(
  credential,
  async ({ data }) => ({
    signature: authentication.sign(data),
    keyType: authentication.type,
    keyUri: `${claimerDid.uri}${claimerDid.authentication[0].id}`
  }),
  [attesterDid]
)
```

Bu satÄ±r, yukarÄ±da tanÄ±mlanan `verificationFlow` fonksiyonunu Ã§aÄŸÄ±rarak doÄŸrulama sÃ¼recini baÅŸlatÄ±r.

#### Hata Yakalama:

```typescript title="verify.ts"
} catch (e) {
  console.log('Error in the verification flow')
  throw e
}
```

Bu kÄ±sÄ±m, doÄŸrulama sÃ¼reci sÄ±rasÄ±nda herhangi bir hata oluÅŸursa bu hatayÄ± yakalar ve bir hata mesajÄ± yazdÄ±rÄ±r.

---
:::info Kodun BÃ¼tÃ¼nÃ¼
Kodun bÃ¼tÃ¼nÃ¼ne bir arada bakarak yapÄ±lan iÅŸlemleri incelememiz gerekirse:

```typescript title="verify.ts"
import { config as envConfig } from 'dotenv'

import * as Kilt from '@kiltprotocol/sdk-js'

import { createPresentation } from './claimer/createPresentation'
import { generateKeypairs } from './claimer/generateKeypairs'
import { generateLightDid } from './claimer/generateLightDid'

function getChallenge(): string {
  return Kilt.Utils.UUID.generate()
}

// Verifies validity, ownership & attestation.
async function verifyPresentation(
  presentation: Kilt.ICredentialPresentation,
  challenge: string,
  trustedAttesterUris: Kilt.DidUri[]
): Promise<boolean> {
  Kilt.ConfigService.get('api')

  try {
    const { revoked, attester } = await Kilt.Credential.verifyPresentation(
      presentation,
      { challenge }
    )

    if (revoked) {
      return false
    }
    // Returns true if no trusted attester URI is provided or, if it is, if it matches the one that issued the presented credential.
    return trustedAttesterUris.includes(attester)
  } catch {
    return false
  }
}

export async function verificationFlow(
  credential: Kilt.ICredential,
  signCallback: Kilt.SignCallback,
  trustedAttesterUris: Kilt.DidUri[] = []
) {
  // Verifier sends a unique challenge to the claimer ğŸ•Š
  const challenge = getChallenge()

  // Create a presentation and send it to the verifier ğŸ•Š
  const presentation = await createPresentation(
    credential,
    signCallback,
    challenge
  )

  // The verifier checks the presentation.
  const isValid = await verifyPresentation(
    presentation,
    challenge,
    trustedAttesterUris
  )

  if (isValid) {
    console.log('Verification successful! You are allowed to enter the club ğŸ‰')
  } else {
    console.log('Verification failed! ğŸš«')
  }
}

// Don't execute if this is imported by another file.
if (require.main === module) {
  ;(async () => {
    envConfig()

    try {
      await Kilt.connect(process.env.WSS_ADDRESS as string)
      const claimerDidMnemonic = process.env.CLAIMER_DID_MNEMONIC as string
      const { authentication } = generateKeypairs(claimerDidMnemonic)
      const claimerDid = generateLightDid(claimerDidMnemonic)
      const attesterDid = process.env.ATTESTER_DID_URI as Kilt.DidUri
      // Load credential and claimer DID
      const credential = JSON.parse(process.env.CLAIMER_CREDENTIAL as string)
      await verificationFlow(
        credential,
        async ({ data }) => ({
          signature: authentication.sign(data),
          keyType: authentication.type,
          keyUri: `${claimerDid.uri}${claimerDid.authentication[0].id}`
        }),
        [attesterDid]
      )
    } catch (e) {
      console.log('Error in the verification flow')
      throw e
    }
  })()
}
```

SÄ±rasÄ±yla iÅŸlevler:
- Paketler eklenir.
- Claimer'Ä±n kendinin `credential`'a sahip olduÄŸunu kanÄ±tlamak iÃ§in bir `challange` oluÅŸturulur. 
- `True` ve `False` ÅŸeklinde bir Ã§Ä±ktÄ± veren `Presantation` onaylama fonksiyonu yazÄ±lÄ±r.
- BaÅŸtan sona tÃ¼m iÅŸlemleri bir arada Ã§alÄ±ÅŸtÄ±rmak iÃ§in verificationFlow() fonksiyonu yazÄ±lÄ±r.
- Fonksiyonun tek baÅŸÄ±na Ã§alÄ±ÅŸÄ±rken neler yapacaÄŸÄ±nÄ± belirten fonksiyon yazÄ±lÄ±r.
:::

## Kodu Ã‡alÄ±ÅŸtÄ±ralÄ±m!

Kodu Ã§alÄ±ÅŸtÄ±rmak iÃ§in terminalde `kilt-rocks` klasÃ¶rÃ¼nde bulunduÄŸumuza  emin olduktan sonra alt kÄ±sÄ±mdaki kodu Ã§alÄ±ÅŸtÄ±rabiliriz:

```terminal
yarn ts-node verify.ts
```

:::danger BAÅARDIN
TÃ¼m bireyleri tÃ¼m kodlarÄ± ile birlikte Ã§alÄ±ÅŸtÄ±rdÄ±n ve hallettin! Seninle gurur duyuyorum! Hadi birlikte KILT-SDK ile projeler gerÃ§ekleÅŸtirelim!

:::