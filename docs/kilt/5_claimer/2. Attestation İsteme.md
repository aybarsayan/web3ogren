# Attestation Talebi ğŸ‰

Bu bÃ¶lÃ¼mde, `Claim` ve `Credential` oluÅŸturacaÄŸÄ±z. Ancak, oluÅŸturduÄŸumuz bu `Credential` ÅŸu an iÃ§in sadece bir kaÄŸÄ±t parÃ§asÄ± gibi. ğŸ“œ Neden mi? Ã‡Ã¼nkÃ¼ `Validator`'lar iÃ§in bu bilginin gÃ¼venilir olabilmesi iÃ§in bir `Attester` tarafÄ±ndan onaylanmÄ±ÅŸ olmasÄ± gerekiyor! ğŸ¤

:::tip ğŸŒŸ YÄ±ldÄ±z Ä°pucu ğŸŒŸ
KILT, herkesin katÄ±labileceÄŸi bir parti gibi! ğŸ‰ Herkes veya her ÅŸey bir `claim` oluÅŸturabilir ve `attest` edebilir. Ancak, burada dikkat etmemiz gereken bir ÅŸey var: EÄŸer bir `Validator` bir `Attester`'a gÃ¼venmiyorsa, o `credential` sadece bir kaÄŸÄ±t parÃ§asÄ±dÄ±r! ğŸ™…â€â™€ï¸
:::

## ğŸ“ Claim OluÅŸturma ğŸ“

Daha Ã¶nce oluÅŸturduÄŸumuz `light DID`, `ctype` ve `Claimer`'Ä±n saÄŸladÄ±ÄŸÄ± bilgilerle, sanki bir yemek tarifi oluÅŸturur gibi bir `Claim` objesi oluÅŸturacaÄŸÄ±z. ğŸ²

:::info ğŸ¤” Claim Nedir? Detaylara Bir GÃ¶z AtalÄ±m ğŸ¤”

- Ã–ncesinde, CTypes'Ä± bir yemek tarifi gibi dÃ¼ÅŸÃ¼nebiliriz; ne yapmamÄ±z gerektiÄŸini bize sÃ¶yler. ğŸ“‘ğŸ²
  
- Peki ya bu tarifi uyguladÄ±ktan sonra ne olur? Yemek tarifi olarak mÄ± kalÄ±r? HayÄ±r, tabii ki! ğŸ™…â€â™‚ï¸ O zaman bir yemek olur! ğŸ²

- AynÄ± ÅŸekilde, CType'Ä± istediÄŸimiz bilgilerle doldurduÄŸumuzda, bu bir `Claim` olur. `Claim`ler, `Credential`lere benzer ama henÃ¼z bir `Attester` tarafÄ±ndan onaylanmamÄ±ÅŸlardÄ±r. ğŸ“ğŸ”

- `Attester`'lar bu sÃ¼reÃ§te kritik bir rol oynarlar, tÄ±pkÄ± bir yemek yarÄ±ÅŸmasÄ±nda jÃ¼ri Ã¼yeleri gibi! ğŸ¤© Onlar `Credential`'i inceleyip onaylayÄ±p onaylamayacaklarÄ±nÄ± belirlerler. âœ…

- KILT, herkesin bir ÅŸeyler iddia edebileceÄŸi, hatta kendileri hakkÄ±nda bile, aÃ§Ä±k bir sistemdir. ğŸŒ Ancak, bir `Claim` yalnÄ±zca bir `Attester` tarafÄ±ndan onaylandÄ±ysa gÃ¼venilir olabilir. Yani, `Verifier`'lar belirli durumlar iÃ§in farklÄ± `Attester`'lara gÃ¼venebilirler. ğŸ”ğŸ”’
:::

### Paketlerin Eklenmesi

```typescript title="claimer/createClaim.ts"
import * as Kilt from '@kiltprotocol/sdk-js'
```

Paketleri dosyamÄ±za eklerken ilk olarak gerekli tek paketin `KILT-SDK` olduÄŸunu fark edebiliriz. Claim'ler diÄŸer formatlara gÃ¶re basit bir yapÄ±ya sahip olduÄŸu iÃ§in tek baÅŸÄ±na yeterli olacaktÄ±r.

### `createClaim` Fonksiyonu

```typescript title="claimer/createClaim.ts"
export function createClaim(
  lightDid: Kilt.DidUri,
  ctype: Kilt.ICType,
  content: Kilt.IClaim['contents']
): Kilt.IClaim {
```

Dosya iÃ§erisinde `Claim`'in yaratÄ±lmasÄ± iÃ§in gerekli fonksiyonu kurabiliriz. Bu fonksiyon iÃ§erisine 3 adet parametre almaktadÄ±r.  Bu parametreler bakÄ±lacak olunursa:
1. `lightDid: Kilt.DidUri`: Light DID'nin URI'si. Bu, iddianÄ±n kim tarafÄ±ndan oluÅŸturulduÄŸunu belirtir.
2. `ctype: Kilt.ICType`: Ä°ddianÄ±n hangi CType'a (Claim Type) uyduÄŸunu belirtir. Yani, bu iddia hangi "form ÅŸablonu"nu kullanÄ±yor?
3. `content: Kilt.IClaim['contents']`: Ä°ddianÄ±n iÃ§eriÄŸi, yani doldurulmuÅŸ formdaki bilgiler.

:::tip
TypeScript dilinde `:` karakteri, bir deÄŸiÅŸkenin, parametrenin veya fonksiyonun dÃ¶nÃ¼ÅŸ tipinin ne olacaÄŸÄ±nÄ± belirtmek iÃ§in kullanÄ±lÄ±r. Bu, tip gÃ¼venliÄŸi saÄŸlar ve kodun daha anlaÅŸÄ±lÄ±r olmasÄ±na yardÄ±mcÄ± olur.

Ã–rneÄŸin, `createClaim` fonksiyonunun tanÄ±mÄ±nda:

```typescript
export function createClaim(
  lightDid: Kilt.DidUri,
  ctype: Kilt.ICType,
  content: Kilt.IClaim['contents']
): Kilt.IClaim {
```

- `lightDid: Kilt.DidUri`: Burada `lightDid` adlÄ± parametrenin tipinin `Kilt.DidUri` olacaÄŸÄ±nÄ± belirtiyoruz.
- `ctype: Kilt.ICType`: `ctype` parametresinin tipinin `Kilt.ICType` olacaÄŸÄ±nÄ± belirtiyoruz.
- `content: Kilt.IClaim['contents']`: `content` parametresinin tipinin `Kilt.IClaim['contents']` olacaÄŸÄ±nÄ± belirtiyoruz.
- `): Kilt.IClaim {`: Fonksiyonun dÃ¶ndÃ¼receÄŸi deÄŸerin tipinin `Kilt.IClaim` olacaÄŸÄ±nÄ± belirtiyoruz.

Bu tÃ¼r belirtimleri, kodunuzun daha gÃ¼venli ve anlaÅŸÄ±lÄ±r olmasÄ±nÄ± saÄŸlar. Ã–rneÄŸin, birisi bu fonksiyonu kullanÄ±rken yanlÄ±ÅŸ bir tipde bir deÄŸer gÃ¶ndermeye Ã§alÄ±ÅŸÄ±rsa, TypeScript bu hatayÄ± derleme aÅŸamasÄ±nda yakalar. Bu da hatalarÄ±n erken teÅŸhis edilmesine ve dÃ¼zeltilmesine yardÄ±mcÄ± olur.
:::

### Ä°ddia OluÅŸturma

Fonksiyonun parametrelerini belirttikten sonra iÃ§erisine girerek iÅŸlevimizi oluÅŸturabiliriz. Bu iÅŸlem `claim` oluÅŸturma eylemi olacaktÄ±r.

```typescript title="claimer/createClaim.ts"
const claim = Kilt.Claim.fromCTypeAndClaimContents(ctype, content, lightDid)
```

`claim` oluÅŸturulurken `Kilt.Claim.fromCTypeAndClaimContents()` fonksiyonu Ã§aÄŸÄ±rÄ±lÄ±r ve iÃ§erisine parametreler girilerek `claim` adÄ±nda bir deÄŸiÅŸken oluÅŸturulur.

### Claim'in DÃ¶ndÃ¼rÃ¼lmesi

```typescript title="claimer/createClaim.ts"
return claim
```

Son olarak, oluÅŸturulan iddia nesnesi dÃ¶ndÃ¼rÃ¼lÃ¼r.

:::info Kodun TamamÄ±
EÄŸer kodun tamamÄ±nÄ± bir arada gÃ¶rmemiz gerekirse:

```typescript title="claimer/createClaim.ts"
import * as Kilt from '@kiltprotocol/sdk-js'

// Create a Claim object from light DID, CType and given content.
export function createClaim(
  lightDid: Kilt.DidUri,
  ctype: Kilt.ICType,
  content: Kilt.IClaim['contents']
): Kilt.IClaim {
  const claim = Kilt.Claim.fromCTypeAndClaimContents(ctype, content, lightDid)

  return claim
}
```

Bu kod parÃ§asÄ±, bir `claim` oluÅŸturmanÄ±n temelini atmaktadÄ±r. `claim` oluÅŸturulduktan sonra, bu iddiayÄ± bir "Attester" (OnaylayÄ±cÄ±) onaylayabilir ve daha sonra bir "Verifier" (DoÄŸrulayÄ±cÄ±) tarafÄ±ndan doÄŸrulanabilir.
:::

## Credential OluÅŸturma

OluÅŸturduÄŸumuz Claim'in `attest` olmasÄ±nÄ± istediÄŸimiz iÃ§in bir `Credential` inÅŸa edebiliriz. Bu iÅŸlemi gerÃ§ekleÅŸtirmek iÃ§in `generateCredential` fonksiyonunu kullanabiliriz. Bu Credential gerekli olan tÃ¼m bilgileri iÃ§erecektir. Bu sayede `Attester` belgeyi `attest` edebilecektir.

### Paketlerin Eklenmesi

```typescript title="claimer/generateCredential.ts"
import { config as envConfig } from 'dotenv'
import * as Kilt from '@kiltprotocol/sdk-js'
import { createClaim } from './createClaim'
import { generateLightDid } from './generateLightDid'
import { getCtypeSchema } from '../attester/ctypeSchema'

```

Paketlerin iÃ§eriklerine bakacak olursak:
- `dotenv`: Ortam deÄŸiÅŸkenlerini yÃ¼klemek iÃ§in kullanÄ±lÄ±r.
- `Kilt`: KILT protokolÃ¼ SDK'sÄ±.
- `createClaim`, `generateLightDid`, `getCtypeSchema`: Ã–nceki kod parÃ§alarÄ±nda tanÄ±mlanmÄ±ÅŸ yardÄ±mcÄ± fonksiyonlar.

### `generateCredential` Fonksiyonu

```typescript title="claimer/generateCredential.ts"
export function generateCredential(
  claimerDid: Kilt.DidUri,
  claimAttributes: Kilt.IClaim['contents']
): Kilt.ICredential {
```

Credential oluÅŸturmak iÃ§in gerekli fonksiyonumuzu yazarak iÅŸe baÅŸlayabiliriz. Bu fonksiyon iÃ§erisine 2 adet parametre alacaktÄ±r. Ã‡Ä±ktÄ± olarak `Kilt.ICredential` tÃ¼rÃ¼nde bir Ã§Ä±ktÄ± verecektir. Parametrelere teker teker bakmamÄ±z gerekirse:
- `claimerDid`: Claimer'Ä±n oluÅŸturduÄŸu Light DID'yi iÃ§erisine alÄ±r.
- `claimAttributes`: Ä°ddia edilen niteliklerin listesini iÃ§erir.

### Claim ve CType'Ä± OluÅŸturma 

```typescript title="claimer/generateCredential.ts"
const ctype = getCtypeSchema()
const claim = createClaim(claimerDid, ctype, claimAttributes)
```

Hem `ctype`'Ä± hemde `claim`'i oluÅŸturma kodunu yazmÄ±ÅŸtÄ±k ve dosyamÄ±za import etmiÅŸtik. Åimdi de bu fonksiyonlarÄ± kullanarak ilk olarak CType ÅŸemasÄ±nÄ± elde edip sonrasÄ±nda `claim` deÄŸerini oluÅŸturma fonksiyonunu Ã§aÄŸÄ±rabiliriz. Yani sÄ±rasÄ±yla:

- `getCtypeSchema()`: Ã–nceden tanÄ±mlanmÄ±ÅŸ bir CType ÅŸemasÄ± getirir.
- `createClaim()`: Belirtilen CType ve Ã¶zniteliklerle bir iddia (`Claim`) oluÅŸturur.

### Credential oluÅŸturma

```typescript title="claimer/generateCredential.ts"
console.log('Claimer -> create request')
return Kilt.Credential.fromClaim(claim)
```

OluÅŸturduÄŸumuz fonksiyonun Ã§Ä±ktÄ±sÄ± olarak kÄ±sacÄ±k ama gÃ¼zel bir `Credential.fromClaim()` kodumuzu Ã§alÄ±ÅŸtÄ±rarak `Claim` Ã¼zerinden `Credential`'i yani kimlik belgemizi oluÅŸturabiliriz.

### Ana Kod BloÄŸu

Bu kÄ±sÄ±mda dosya tek baÅŸÄ±na Ã§alÄ±ÅŸtÄ±rÄ±lÄ±rsa gerÃ§ekleÅŸecek iÅŸlemler verilmiÅŸtir.

```typescript title="claimer/generateCredential.ts"
if (require.main === module) {
	.
	.
	.
  })()
}
```

YukarÄ±da da ifade edildiÄŸi gibi `if` yapÄ±sÄ± ile kodun tek baÅŸÄ±na Ã§alÄ±ÅŸÄ±p Ã§alÄ±ÅŸmadÄ±ÄŸÄ± kontrol edilir.

```typescript title="claimer/generateCredential.ts"
envConfig()
```

Bu fonksiyon ile `.env` dosyasÄ±ndaki ortam deÄŸiÅŸkenlerini kod iÃ§erisine ekleriz.

```typescript title="claimer/generateCredential.ts"
    try {
		.
		.
		.
    } catch (e) {
      console.log('Error while building credential')
      throw e
    }
```

Fonksiyonun Ã§alÄ±ÅŸmasÄ± iÃ§in bir `try` `catch` yapÄ±sÄ± kurulur. EÄŸer iÅŸlemlerde bir hata bulunursa hata kullanÄ±cÄ±ya `log` yapÄ±sÄ± ile ekrana yazdÄ±rÄ±lÄ±r.

ArtÄ±k `try` yapÄ±sÄ± iÃ§erisinde `credential` yapÄ±sÄ± kurulabilir.

```typescript title="claimer/generateCredential.ts"
await Kilt.init()
```

Try yapÄ±sÄ± iÃ§erisine girdiÄŸimizde `credential` oluÅŸturmak iÃ§in `Kilt.init` yapÄ±sÄ± ile KILT SDK'yi proje iÃ§erisine ekleyebiliriz.

#### Mnemonik AnahtarÄ± Al

```typescript title="claimer/generateCredential.ts"
const claimerDidMnemonic = process.env.CLAIMER_DID_MNEMONIC as string
```

Ortam deÄŸiÅŸkenlerinden `CLAIMER_DID_MNEMONIC`'i alÄ±r ve bir string olarak saklar.

#### Light DID OluÅŸturma

```typescript title="claimer/generateCredential.ts"
const claimerDid = generateLightDid(claimerDidMnemonic)
```

Daha Ã¶nce diÄŸer kod dosyasÄ±nda tanÄ±mlamÄ±ÅŸ olduÄŸumuz `generateLightDid` fonksiyonunu kullanarak, mnemonikten bir `light DID` oluÅŸturur.

### Credential'Ä± Yaratmak

```typescript title="claimer/generateCredential.ts"
const request = generateCredential(claimerDid.uri, 
								   { age: 21, 
								   name: 'Aybars GÃ¶ktuÄŸ Ayan' 
								   })
								   
console.log('âš ï¸   ./claimer/_credential.json dosyasÄ±na kaydet  âš ï¸\n\n')
console.log(JSON.stringify(request, null, 2))
```

Son olarak `generateCredential` fonksiyonu ile `claim`'i doldurup `credential` formatÄ±na getiririz. Bu fonksiyon, oluÅŸturulan DID ve belirtilen nitelikler (`age` ve `name`) ile bir credential oluÅŸturur. SonrasÄ±nda oluÅŸturulan kimlik bilgisini JSON formatÄ±nda konsola yazdÄ±rÄ±r.


:::info Genel BakÄ±ÅŸ
Kodun tamamÄ±na bakacak olursak:
```typescript title="claimer/generateCredential.ts"
import { config as envConfig } from 'dotenv'

import * as Kilt from '@kiltprotocol/sdk-js'

import { createClaim } from './createClaim'
import { generateLightDid } from './generateLightDid'
import { getCtypeSchema } from '../attester/ctypeSchema'

export function generateCredential(
  claimerDid: Kilt.DidUri,
  claimAttributes: Kilt.IClaim['contents']
): Kilt.ICredential {
  // Create claim.
  const ctype = getCtypeSchema()
  const claim = createClaim(claimerDid, ctype, claimAttributes)

  // Create credential and request attestation.
  console.log('Claimer -> create request')
  return Kilt.Credential.fromClaim(claim)
}

// Don't execute if this is imported by another file.
if (require.main === module) {
  ;(async () => {
    envConfig()

    try {
      await Kilt.init()

      const claimerDidMnemonic = process.env.CLAIMER_DID_MNEMONIC as string
      const claimerDid = generateLightDid(claimerDidMnemonic)

      const request = generateCredential(claimerDid.uri, {
        age: 21,
        name: 'Aybars GÃ¶ktuÄŸ Ayan'
      })
      console.log(
        'âš ï¸  save this to ./claimer/_credential.json for testing  âš ï¸\n\n'
      )
      console.log(JSON.stringify(request, null, 2))
    } catch (e) {
      console.log('Error while building credential')
      throw e
    }
  })()
}
```
SÄ±rasÄ±yla inceleyecek olursak:
- Paketleri ekleriz.
- Claim oluÅŸtururuz
- Claim ile Credential oluÅŸtururuz ve zincire kaydederiz.
:::

## ProgramÄ± Ã§alÄ±ÅŸtÄ±rmak

YazdÄ±ÄŸÄ±mÄ±z birbirine baÄŸlÄ± 2 kodu Ã§alÄ±ÅŸtÄ±rmak iÃ§in `kilt-rocks` klasÃ¶rÃ¼nde olduÄŸumuza emin olduktan sonra alt kÄ±sÄ±mdaki kodu Ã§alÄ±ÅŸtÄ±rabiliriz.

```terminal
yarn ts-node claimer/generateCredential.ts
```


---

:::caution
Attestation'lar `Attester`'lar tarafÄ±ndan onaylandÄ±ktan sonra zincir Ã¼zerine kaydedilirler. Bu iÅŸlem bir depozito gerektirir. Her Credential birbirinden Ã¶zeldir. Test yaparken genel olarak `credential`'larÄ± depolayÄ±p yeniden kullanÄ±ma sokarak birden fazla `attestation` iÅŸleminin Ã¶nÃ¼ne geÃ§miÅŸ oluruz.

Bu belgeyi kaydetmek iÃ§in `./claimer/_credential.json` konumunda bir dosya oluÅŸturup iÃ§erisine bilgileri yazabiliriz. Hatta bu `credential`'Ä± arkadaÅŸlarÄ±nÄ±z ile paylaÅŸÄ±p onlarÄ±n kullanmasÄ±nÄ± da saÄŸlayabilirsiniz.
:::

:::info Afferin bize
Evet, artÄ±k `Claimer` olarak `Claim` oluÅŸturduk ve bu `Claim` iÃ§erisinden `credential` oluÅŸturduk. Åimdi attester'Ä± tamamlayarak `credential`'Ä± attest edelim. 
:::